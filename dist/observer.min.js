!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("utility")):"function"==typeof define&&define.amd?define("observer",["utility"],e):t.observer=e(t.utility)}(this,function(t){function e(t){return e.proxy(t)}function r(r){var n=r!==u?function(t,r){e[r]=t}:function(r,n){e[n]=t.emptyFunc};t.each(f,n),t.each(r,function(t,r){e[r]=t})}function n(){}function i(e,r,n){var i=t.getOwnProp(e,p.observerKey);return i?1==arguments.length?i.hasListen():2==arguments.length?i.hasListen(r):i.hasListen(r,n):!1}function s(r,n,i){var s=t.getOwnProp(r,p.observerKey);return s||(r=e.obj(r),s=new l(r),r[p.observerKey]=s),s.on(n,i)}function o(e,r,n){var i=t.getOwnProp(e,p.observerKey);return i&&(e=2==arguments.length?i.un(r):i.un(r,n),!i.hasListen())?(e[p.observerKey]=void 0,i.destroy()):e}t="default"in t?t["default"]:t;var c=new t.Configuration,a=t.hasOwnProp,h="proxyListenKey";c.register(h,"__PROXY_LISTENERS__");var u={eq:function(t,e){return t===e},obj:function(t){return t},proxy:function(t){return t}},f={change:function(e,r){var n=t.getOwnProp(e,c.get(h));if(n)for(var i=n.length;i--;)n[i](e,r)},on:function(e,r){if(!t.isFunc(r))throw TypeError("Invalid Proxy Event Handler["+r);var n=c.get(h),i=t.getOwnProp(e,n);i||(e[n]=i=[]),i.push(r)},un:function(e,r){var n=t.getOwnProp(e,c.get(h));if(n&&t.isFunc(r))for(var i=n.length;i-- >0;)if(n[i]===r)return n.splice(i,1),!0;return!1},clean:function(t){t[e.listenKey]&&(t[e.listenKey]=void 0)}};t.assign(e,{isEnable:function(){return policy===u},enable:function(t){r(t)},disable:function(){r(u)}}),e.disable(),t.get=function(r,n,i,s,o){for(var c=0,h=t.parseExpr(n,!0),u=h.length-1,f=void 0;!t.isNil(r)&&u>c;){if(f=h[c++],r=e.obj(r),o&&!a(r,f))return i;r=r[f]}return r=e.obj(r),f=h[c],c==u&&!t.isNil(r)&&(o?a(r,f):f in r)?r[f]:i},t.hasOwnProp=function(t,r){return a(e.obj(t),r)};var d=t.timeoutframe,p=c.get();c.register({lazy:!0,animationFrame:!0,observerKey:"__OBSERVER__",expressionKey:"__EXPR_OBSERVER__"});var l=t.dynamicClass({constructor:function(e){if(this.isArray=t.isArray(e),!this.isArray&&!t.isObject(e))throw TypeError("can not observe object["+Object.prototype.toString.call(e)+"]");this.target=e,this.obj=e,this.listens={},this.changeRecords={},this._notify=this._notify.bind(this),this.watchPropNum=0,this._init()},_fire:function(r,n,i){var s=this,o=this.listens[r];o||e.eq(n,i)&&!t.isArray(n)||t.each(o.slice(),function(t){t(r,n,i,s.target)})},_notify:function(){var e=this,r=this.obj;t.each(this.changeRecords,function(t,n){e._fire(n,r[n],t)}),this.request_frame=void 0,this.changeRecords={}},_addChangeRecord:function(t,e){p.lazy?t in this.changeRecords||(this.changeRecords[t]=e,this.request_frame||(this.request_frame=p.animationFrame?window.requestAnimationFrame(this._notify):d.request(this._notify))):this._fire(t,this.obj[t],e)},checkHandler:function(e){if(!t.isFunc(e))throw TypeError("Invalid Observe Handler")},hasListen:function(e,r){switch(arguments.length){case 0:return!!this.watchPropNum;case 1:return t.isFunc(e)?!t.each(this.listens,function(r){return-1!==t.lastIndexOf(r,e)}):!!listens[e];default:return this.checkHandler(r),-1!==t.lastIndexOf(listens[e],r)}},on:function(t,e){var r=void 0;return this.checkHandler(e),(r=this.listens[t])?r.push(e):(this.listens[t]=[e],this.watchPropNum++,this._watch(t)),this.target},_cleanListen:function(t){this.listens[t]=void 0,this.watchPropNum--,this._unwatch(t)},un:function(t,e){var r=this.listens[t];if(r)if(1==arguments.length)this._cleanListen(t);else{this.checkHandler(e);for(var n=r.length;n--;)if(r[n]===e){r.splice(n,1),r.length||this._cleanListen(t);break}}return this.target},destroy:function(){this.request_frame&&(p.animationFrame?window.cancelAnimationFrame(this.request_frame):d.cancel(this.request_frame),this.request_frame=void 0);var t=this.obj;return this._destroy(),this.obj=void 0,this.target=void 0,this.listens=void 0,this.changeRecords=void 0,t},_init:n,_destroy:n,_watch:n,_unwatch:n}),v=0,y=t.dynamicClass({constructor:function(r,n,i){this.id=v++,this.expr=n,this.handlers=[],this.observers=[],this.path=i||t.parseExpr(n),this.observeHandlers=this._initObserveHandlers(),this.obj=e.obj(r),this.target=this._observe(this.obj,0),this._onTargetProxy=this._onTargetProxy.bind(this),e.on(r,this._onTargetProxy)},_onTargetProxy:function(t,e){this.target=e},_observe:function(t,r){var n=this.path[r],i=void 0;return r+1<this.path.length&&(i=t[n])&&(t[n]=this._observe(e.obj(i),r+1)),s(t,n,this.observeHandlers[r])},_unobserve:function(t,r){var n=this.path[r],i=void 0,s=void 0;return s=o(t,n,this.observeHandlers[r]),r+1<this.path.length&&(i=t[n])&&(t[n]=this._unobserve(e.obj(i),r+1)),s},_initObserveHandlers:function(){return t.map(this.path,function(t,e){return this._createObserveHandler(e)},this)},_createObserveHandler:function(r){var n=this,i=(this.path.slice(0,r+1),this.path.slice(r+1)),s=this.path.length-r-1;return function(o,c,a){s&&(a?(a=e.obj(a),n._unobserve(a,r+1),a=t.get(a,i)):a=void 0,c?(c=e.obj(c),n._observe(c,r+1),c=t.get(c,i)):c=void 0,e.eq(c,a))||t.each(n.handlers.slice(),function(t){t(this.expr,c,a,this.target)},n)}},checkHandler:function(e){if(!t.isFunc(e))throw TypeError("Invalid Observe Handler")},on:function(t){return this.checkHandler(t),this.handlers.push(t),this},un:function(t){if(arguments.length){this.checkHandler(t);for(var e=this.handlers,r=e.length;r--;)if(e[r]===t){e.splice(r,1);break}}else this.handlers=[];return this},hasListen:function(e){return arguments.length?-1!=t.lastIndexOf(this.handlers,e):!!this.handlers.length},destory:function(){e.un(this.target,this._onTargetProxy);var t=this._unobserve(this.obj,0);return this.obj=void 0,this.target=void 0,this.expr=void 0,this.handlers=void 0,this.path=void 0,this.observers=void 0,this.observeHandlers=void 0,this.target=void 0,t}}),g=[],_=!1,b={registerPolicy:function(t,e,r,n){return g.push({name:t,priority:e,policy:n,checker:r}),g.sort(function(t,e){return t.priority-e.priority}),this},init:function(e){if(!_){if(c.config(e),t.each(g,function(e){return e.checker(p)?(t.each(e.policy(p),function(t,e){l.prototype[e]=t}),p.policy=e.name,!1):void 0})!==!1)throw Error("not supported");_=!0}return this},on:function(e,r,n){var i=t.parseExpr(r);if(i.length>1){var o=t.getOwnProp(e,p.expressionKey),c=o?o[r]:void 0;return c||(c=new y(e,r,i),o||(o=e[p.expressionKey]={}),o[r]=c),c.on(n),c.target}return s(e,r,n)},un:function(r,n,i){var s=t.parseExpr(n);if(s.length>1){var c=t.getOwnProp(r,p.expressionKey),a=c?c[n]:void 0;return a?(2==arguments.length?a.un():a.un(i),a.hasListen()?a.target:(c[n]=void 0,a.destory())):e.proxy(r)||r}return 2==arguments.length?o(r,n):o(r,n,i)},hasListen:function(e,r,n){var s=arguments.length;switch(s){case 1:return i(e);case 2:if(t.isFunc(r))return i(e,r)}var o=t.parseExpr(r);if(o.length>1){var c=t.getOwnProp(e,p.expressionKey),a=c?c[r]:void 0;return a?2==s?!0:a.hasListen(n):!1}return i.apply(window,arguments)}};c.register({es6Proxy:!0,es6SourceKey:"__ES6_PROXY_SOURCE__",es6ProxyKey:"__ES6_PROXY__"}),b.registerPolicy("ES6Proxy",1,function(t){return window.Proxy&&t.es6Proxy!==!1},function(r){var n=r.es6SourceKey,i=r.es6ProxyKey;return e.enable({obj:function(e){return e?t.getOwnProp(e,n)||e:e},eq:function(t,r){return t===r||t&&r&&e.obj(t)===e.obj(r)},proxy:function(e){return e?t.getOwnProp(e,i):void 0}}),{_init:function(){this.obj=e.obj(this.target),this.es6proxy=!1},_destroy:function(){this.es6proxy=!1,this.obj[i]=void 0,e.change(this.obj,void 0)},_watch:function(t){if(!this.es6proxy){var r=this._objectProxy(),s=this.obj;this.target=r,s[i]=r,s[n]=s,e.change(s,r),this.es6proxy=!0}},_unwatch:function(t){},_objectProxy:function(){var t=this;return new Proxy(this.obj,{set:function(e,r,n){if(t.listens[r]){var i=e[r];e[r]=n,t._addChangeRecord(r,i)}else e[r]=n;return!0}})}}});var P=Object.prototype.hasOwnProperty,x="hasOwnProperty,toString,toLocaleString,isPrototypeOf,propertyIsEnumerable,valueOf".split(","),j="concat,copyWithin,entries,every,fill,filter,find,findIndex,forEach,indexOf,lastIndexOf,length,map,keys,join,pop,push,reverse,reverseRight,some,shift,slice,sort,splice,toSource,unshift".split(","),w=t.dynamicClass({constBind:"__VB_CONST__",descBind:"__VB_PROXY__",classNameGenerator:0,constructor:function(t,e){this.classPool={},this.defPropMap={},this.onProxyChange=e,this.addDefProps(t),this.initConstScript()},setConstBind:function(t){this.constBind=t,this.initConstScript()},setDescBind:function(t){this.descBind=t,this.initConstScript()},addDefProps:function(e){var r=this.defPropMap;t.each(e||[],function(t){r[t]=!0}),this.defProps=t.keys(r),this.initReserveProps()},initReserveProps:function(){this.reserveProps=x.concat(t.keys(this.defPropMap)||[]),this.reserveArrayProps=this.reserveProps.concat(j),this.reservePropMap=t.reverseConvert(this.reserveProps),this.reserveArrayPropMap=t.reverseConvert(this.reserveArrayProps)},initConstScript:function(){this.constScript=["	Public [",this.descBind,"]\r\n","	Public Default Function [",this.constBind,"](desc)\r\n","		set [",this.descBind,"] = desc\r\n","		Set [",this.constBind,"] = Me\r\n","	End Function\r\n"].join("")},generateClassName:function(){return"VBClass"+this.classNameGenerator++},parseClassConstructorName:function(t){return t+"Constructor"},generateSetter:function(t){var e=this.descBind;return["	Public Property Get [",t,"]\r\n","	On Error Resume Next\r\n","		Set[",t,"] = [",e,'].get("',t,'")\r\n',"	If Err.Number <> 0 Then\r\n","		[",t,"] = [",e,'].get("',t,'")\r\n',"	End If\r\n","	On Error Goto 0\r\n","	End Property\r\n"]},generateGetter:function(t){var e=this.descBind;return["	Public Property Let [",t,"](val)\r\n","		Call [",e,'].set("',t,'",val)\r\n',"	End Property\r\n","	Public Property Set [",t,"](val)\r\n","		Call [",e,'].set("',t,'",val)\r\n',"	End Property\r\n"]},generateClass:function(e,r,n){var i=this,s=["Class ",e,"\r\n",this.constScript,"\r\n"];return t.each(r,function(t){n[t]?s.push("	Public ["+t+"]\r\n"):(s.push.apply(s,i.generateSetter(t)),s.push.apply(s,i.generateGetter(t)))}),s.push("End Class\r\n"),s.join("")},generateClassConstructor:function(t,e,r){var n=[t.length,"[",t.join(","),"]","[",r.join(","),"]"].join(""),i=this.classPool[n];if(i)return i;var s=this.generateClassName();return i=this.parseClassConstructorName(s),parseVB(this.generateClass(s,t,e)),parseVB(["Function ",i,"(desc)\r\n","	Dim o\r\n","	Set o = (New ",s,")(desc)\r\n","	Set ",i," = o\r\n","End Function"].join("")),this.classPool[n]=i,i},create:function(e,r){function n(r){t.isFunc(e[r])&&(h[r]=!0,a.push(r)),c.push(r)}var i=this,s=void 0,o=void 0,c=[],a=[],h={},u=this.descBind;return t.isArray(e)?(s=this.reserveArrayProps,o=this.reserveArrayPropMap):(s=this.reserveProps,o=this.reservePropMap),t.each(s,n),t.each(e,function(t,e){e===u||e in o||n(e)},e,!1),r||(r=this.descriptor(e),r?e=r.obj:r=new m(e,c,this)),proxy=window[this.generateClassConstructor(c,h,a)](r),t.each(a,function(t){proxy[t]=i.funcProxy(e[t],proxy)}),r.proxy=proxy,this.onProxyChange(e,proxy),proxy},funcProxy:function(t,e){return function(){t.apply(this&&this!=window?this:e,arguments)}},eq:function(t,e){var r=this.descriptor(t),n=this.descriptor(e);return r&&(t=r.obj),n&&(e=n.obj),t===e},obj:function(t){var e=this.descriptor(t);return e?e.obj:t},proxy:function(t){var e=this.descriptor(t);return e?e.proxy:void 0},isProxy:function(t){return P.call(t,this.constBind)},descriptor:function(t){var e=this.descBind;return P.call(t,e)?t[e]:void 0},destroy:function(t){var e=this.descriptor(t);return e&&(t=e.obj,this.onProxyChange(t,void 0)),t}}),m=t.dynamicClass({constructor:function(e,r,n){this.classGenerator=n,this.obj=e,this.defines=t.reverseConvert(r,function(){return!1}),e[n.descBind]=this,this.accessorNR=0},isAccessor:function(t){return t&&(t.get||t.set)},hasAccessor:function(){return!!this.accessorNR},defineProperty:function(e,r){var n=this.defines,i=this.obj;return e in n||(e in i?t.isFunc(i[e])&&console.warn("defineProperty not support function ["+e+"]"):i[e]=void 0,this.classGenerator.create(this.obj,this)),this.isAccessor(r)?(n[e]=r,this.accessorNR++,r.get&&(i[e]=r.get())):(n[e]&&(n[e]=!1,this.accessorNR--),i[e]=r.value),this.proxy},getPropertyDefine:function(t){return this.defines[t]||void 0},get:function(t){var e=this.defines[t];return e&&e.get?e.get.call(this.proxy):this.obj[t]},set:function(t,e){var r=this.defines[t];r&&r.set&&r.set.call(this.proxy,e),this.obj[t]=e}}),O=void 0;w.isSupport=function(){if(void 0!==O)return O;if(O=!1,window.VBArray)try{window.execScript(["Function parseVB(code)","	ExecuteGlobal(code)","End Function"].join("\n"),"VBScript"),O=!0}catch(t){console.error(t.message,t)}return O};var C={_init:function(){this.watchers={}},_destroy:function(){for(var t in this.watchers)this.watchers[t]&&this._unwatch(t);this.watchers=void 0},_watch:function(t){this.watchers[t]||(this._defineProperty(t,this.obj[t]),this.watchers[t]=!0)},_unwatch:function(t){this.watchers[t]&&this._undefineProperty(t,this.obj[t])}};b.registerPolicy("ES5DefineProperty",10,function(t){if(Object.defineProperty)try{var e=function(){var t=void 0,e={};return Object.defineProperty(e,"sentinel",{get:function(){return t},set:function(e){t=e}}),e.sentinel=1,{v:e.sentinel===t}}();if("object"==typeof e)return e.v}catch(r){}return!1},function(e){return proxyPro.disable(),t.assignIf({_defineProperty:function(t,e){var r=this;Object.defineProperty(this.target,t,{enumerable:!0,configurable:!0,get:function(){return e},set:function(n){var i=e;e=n,r._addChangeRecord(t,i)}})},_undefineProperty:function(t,e){Object.defineProperty(this.target,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}},C)}),b.registerPolicy("DefineGetterAndSetter",20,function(t){return"__defineGetter__"in{}},function(e){return proxyPro.disable(),t.assignIf({_defineProperty:function(t,e){var r=this;this.target.__defineGetter__(t,function(){return e}),this.target.__defineSetter__(t,function(n){var i=e;e=n,r._addChangeRecord(t,i)})},_undefineProperty:function(t,e){this.target.__defineGetter__(t,function(){return e}),this.target.__defineSetter__(t,function(t){e=t})}},C)}),b.registerPolicy("VBScriptProxy",30,function(t){return w.isSupport()},function(e){var r=C._init,n=void 0;return proxyPro.enable({obj:function(t){return t?n.obj(t):t},eq:function(t,e){return t===e||t&&e&&n.obj(t)===n.obj(e)},proxy:function(t){return t?n.proxy(t):void 0}}),n=b.vbfactory=new w([proxyPro.listenKey,e.observerKey,e.expressionKey],proxyPro.change),t.assignIf({_init:function(){r.call(this),this.obj=n.obj(this.target)},_defineProperty:function(t,e){var r=this,i=this.obj,s=n.descriptor(i);s||(s=n.descriptor(n.create(i))),this.target=s.defineProperty(t,{set:function(e){var n=r.obj[t];r.obj[t]=e,r._addChangeRecord(t,n)}})},_undefineProperty:function(t,e){var r=this.obj,i=n.descriptor(r);i&&(this.target=i.defineProperty(t,{value:e}),i.hasAccessor()||(this.target=n.destroy(r)))}},C)});var E=t.assignIf(b,t,{eq:function(t,r){return e.eq(t,r)},obj:function(t){return e.obj(t)},onproxy:function(t,r){return e.on(t,r)},unproxy:function(t,r){return e.un(t,r)},proxy:e,config:c.get()});return E});
//# sourceMappingURL=observer.min.js.map