!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("utility")):"function"==typeof define&&define.amd?define("observer",["utility"],e):t.observer=e(t.utility)}(this,function(t){function e(t){return e.proxy(t)}function r(r){var n=r!==f?function(t,r){e[r]=t}:function(r,n){e[n]=t.emptyFunc};t.each(p,n),t.each(r,function(t,r){e[r]=t})}function n(e,r,n){var i=t.getOwnProp(e,v.observerKey);return!!i&&(1==arguments.length?i.hasListen():2==arguments.length?i.hasListen(r):i.hasListen(r,n))}function i(e,r,n){var i=t.getOwnProp(e,v.observerKey);return i||(i=new b(e),e[v.observerKey]=i),i.on(r,n)}function s(e,r,n){var i=t.getOwnProp(e,v.observerKey);return i?2==arguments.length?i.un(r):i.un(r,n):e}function o(t,r,n,i,s){var o=this;return t(r,function(t,r,i,s){return n.call(o,e.proxy(t),r,i,s)},i,s)}t="default"in t?t.default:t;var c=new t.Configuration,a=Object.prototype.hasOwnProperty,u="proxyListenKey",h=t.LinkedList;c.register(u,"__PROXY_LISTENERS__");var f={eq:function(t,e){return t===e},obj:function(t){return t},proxy:function(t){return t}},p={change:function(e,r){var n=t.getOwnProp(e,c.get(u));n&&n.each(function(t){return t(e,r)})},on:function(e,r){if(!t.isFunc(r))throw TypeError("Invalid Proxy Event Handler["+r);var n=c.get(u),i=t.getOwnProp(e,n);i||(e[n]=i=new h),i.push(r)},un:function(e,r){var n=t.getOwnProp(e,c.get(u));return n&&t.isFunc(r)&&n.remove(r),!1},clean:function(t){t[e.listenKey]&&(t[e.listenKey]=void 0)}},l=!1;t.assign(e,{isEnable:function(){return e.on!==t.emptyFunc},enable:function(n){r(n),l||(t.overridePolicy("hasOwn",function(t,r){return a.call(e.obj(t),r)}),t.overridePolicy("eq",e.eq),l=!0)},disable:function(){r(f)}}),e.disable();var d=new t.Logger("observer","info"),y=t.timeoutframe,v=c.get(),g=t.LinkedList;c.register({lazy:!0,animationFrame:!0,observerKey:"__OBSERVER__",expressionKey:"__EXPR_OBSERVER__"});var b=t.dynamicClass({constructor:function(t){this.obj=t,this.target=t,this.listens={},this.changeRecords={},this.notify=this.notify.bind(this),this.watchPropNum=0,this.init()},fire:function(r,n,i){var s=this,o=this.listens[r];if(o){var c=t.isPrimitive(n),a=e.eq(n,i);c&&a||o.each(function(t){t(r,n,i,s.target,a)})}},notify:function(){var e=this,r=this.obj,n=this.changeRecords;this.request_frame=void 0,this.changeRecords={},t.each(n,function(t,n){e.fire(n,r[n],t)})},addChangeRecord:function(t,e){v.lazy?t in this.changeRecords||!this.listens[t]||(this.changeRecords[t]=e,this.request_frame||(this.request_frame=v.animationFrame?window.requestAnimationFrame(this.notify):y.request(this.notify))):this.fire(t,this.obj[t],e)},hasListen:function(e,r){switch(arguments.length){case 0:return!!this.watchPropNum;case 1:return t.isFunc(e)?!t.each(this.listens,function(t){return t.contains(e)}):!!this.listens[e];default:var n=this.listens[e];return!!n&&n.contains(r)}},on:function(t,e){var r=void 0;return(r=this.listens[t])||(this.listens[t]=r=new g),r.empty()&&(this.watchPropNum++,this.watch(t)),r.push(e),this.target},un:function(t,e){var r=this.listens[t];return r&&!r.empty()&&(1==arguments.length?(r.clean(),this.watchPropNum--,this.unwatch(t)):(r.remove(e),r.empty()&&(this.watchPropNum--,this.unwatch(t)))),this.watchPropNum?this.target:this.obj},init:t.emptyFunc,watch:t.emptyFunc,unwatch:t.emptyFunc}),P=0,_=t.dynamicClass({constructor:function(r,n,i){this.id=P++,this.expr=n,this.handlers=new g,this.observers=[],this.path=i||t.parseExpr(n),this.observeHandlers=this._initObserveHandlers(),this.obj=r,this.target=this._observe(r,0),e.isEnable()&&(this._onTargetProxy=this._onTargetProxy.bind(this),e.on(r,this._onTargetProxy))},_onTargetProxy:function(t,e){this.target=e},_observe:function(t,r){var n=this.path[r],s=void 0;return r+1<this.path.length&&(s=t[n])&&(s=this._observe(e.obj(s),r+1),e.isEnable()&&(t[n]=s)),i(t,n,this.observeHandlers[r])},_unobserve:function(t,r){var n=this.path[r],i=void 0,o=void 0;return o=s(t,n,this.observeHandlers[r]),r+1<this.path.length&&(i=t[n])&&(i=this._unobserve(e.obj(i),r+1),e.isEnable()&&(t[n]=i)),o},_initObserveHandlers:function(){return t.map(this.path,function(t,e){return this._createObserveHandler(e)},this)},_createObserveHandler:function(r){var n=this,i=this.path.slice(0,r+1),s=this.path.slice(r+1),o=this.path.length-r-1;return function(c,a,u,h,f){if(o){if(f)return;if(u?(u=e.obj(u),n._unobserve(u,r+1),u=t.get(u,s)):u=void 0,a){var p=e.obj(a);if(a=t.get(p,s),p=n._observe(p,r+1),e.isEnable()){for(var l=0,d=n.obj;l<r;)if(d=e.obj(d[i[l++]]),!d)return;d[i[l]]=p}}else a=void 0;var y=t.isPrimitive(a);if(f=e.eq(a,u),y&&f)return}n.handlers.each(function(t){return t(n.expr,a,u,n.target,f)})}},on:function(t){return this.handlers.push(t),this},un:function(t){return arguments.length?this.handlers.remove(t):this.handlers.clean(),this},hasListen:function(t){return arguments.length?this.handlers.contains(t):!this.handlers.empty()}}),x=[],j=!1,w={on:function(r,n,s){var o=t.parseExpr(n);if(r=e.obj(r),o.length>1){var c=t.getOwnProp(r,v.expressionKey),a=c?c[n]:void 0;return a||(a=new _(r,n,o),c||(c=r[v.expressionKey]={}),c[n]=a),a.on(s),a.target}return i(r,n,s)},un:function(r,n,i){var o=t.parseExpr(n);if(r=e.obj(r),o.length>1){var c=t.getOwnProp(r,v.expressionKey),a=c?c[n]:void 0;return a?(2==arguments.length?a.un():a.un(i),a.hasListen()?a.target:a.obj):r}return 2==arguments.length?s(r,n):s(r,n,i)},hasListen:function(r,i,s){var o=arguments.length;switch(r=e.obj(r),o){case 1:return n(r);case 2:if(t.isFunc(i))return n(r,i)}var c=t.parseExpr(i);if(c.length>1){var a=t.getOwnProp(r,v.expressionKey),u=a?a[i]:void 0;return!!u&&(2==o||u.hasListen(s))}return n.apply(null,arguments)},registerPolicy:function(t,e,r,n){return x.push({name:t,priority:e,policy:n,checker:r}),x.sort(function(t,e){return t.priority-e.priority}),d.info("register observe policy[%s], priority is %d",t,e),this},init:function(e){if(!j){if(c.config(e),t.each(x,function(e){if(e.checker(v))return t.each(e.policy(v),function(t,e){b.prototype[e]=t}),v.policy=e.name,d.info("apply observe policy[%s], priority is %d",e.name,e.priority),!1})!==!1)throw Error("observer is not supported");j=!0}return this}};c.register({es6Proxy:!0,es6SourceKey:"__ES6_PROXY_SOURCE__",es6ProxyKey:"__ES6_PROXY__"});var m=Object.prototype.hasOwnProperty;w.registerPolicy("ES6Proxy",1,function(t){return window.Proxy&&t.es6Proxy!==!1},function(t){var r=t.es6SourceKey,n=t.es6ProxyKey;return e.enable({obj:function(t){return t&&m.call(t,r)?t[r]:t},eq:function(t,r){return t===r||e.obj(t)===e.obj(r)},proxy:function(t){return t&&m.call(t,n)?t[n]||t:t}}),{init:function(){this.es6proxy=!1},watch:function(t){if(!this.es6proxy){var i=this.objectProxy(),s=this.obj;this.target=i,s[n]=i,s[r]=s,e.change(s,i),this.es6proxy=!0}},unwatch:function(t){},objectProxy:function(){var t=this;return new Proxy(this.obj,{set:function(e,r,n){if(t.listens[r]){var i=e[r];e[r]=n,t.addChangeRecord(r,i)}else e[r]=n;return!0}})}}});var C=Object.prototype.hasOwnProperty,O="hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),E="concat,copyWithin,entries,every,fill,filter,find,findIndex,forEach,includes,indexOf,join,keys,lastIndexOf,map,pop,push,reduce,reduceRight,reverse,shift,slice,some,sort,splice,unshift,values".split(","),S=t.dynamicClass({constBind:"__VB_CONST__",descBind:"__VB_PROXY__",classNameGenerator:0,constructor:function(t,e){this.classPool={},this.defPropMap={},this.onProxyChange=e,this.addDefProps(t),this.initConstScript()},setConstBind:function(t){this.constBind=t,this.initConstScript()},setDescBind:function(t){this.descBind=t,this.initConstScript()},addDefProps:function(e){var r=this.defPropMap,n=[];t.each(e||[],function(t){r[t]=!0});for(var i in r)C.call(r,i)&&n.push(i);this.defProps=n,d.info("VBProxy default props is: ",n.join(",")),this.initReserveProps()},initReserveProps:function(){this.reserveProps=O.concat(this.defProps),this.reserveArrayProps=this.reserveProps.concat(E),this.reservePropMap=t.reverseConvert(this.reserveProps),this.reserveArrayPropMap=t.reverseConvert(this.reserveArrayProps)},initConstScript:function(){this.constScript=["\tPublic [",this.descBind,"]\r\n","\tPublic Default Function [",this.constBind,"](desc)\r\n","\t\tset [",this.descBind,"] = desc\r\n","\t\tSet [",this.constBind,"] = Me\r\n","\tEnd Function\r\n"].join("")},generateClassName:function(){return"VBClass"+this.classNameGenerator++},parseClassConstructorName:function(t){return t+"Constructor"},generateSetter:function(t){var e=this.descBind;return["\tPublic Property Get [",t,"]\r\n","\tOn Error Resume Next\r\n","\t\tSet[",t,"] = [",e,'].get("',t,'")\r\n',"\tIf Err.Number <> 0 Then\r\n","\t\t[",t,"] = [",e,'].get("',t,'")\r\n',"\tEnd If\r\n","\tOn Error Goto 0\r\n","\tEnd Property\r\n"]},generateGetter:function(t){var e=this.descBind;return["\tPublic Property Let [",t,"](val)\r\n","\t\tCall [",e,'].set("',t,'",val)\r\n',"\tEnd Property\r\n","\tPublic Property Set [",t,"](val)\r\n","\t\tCall [",e,'].set("',t,'",val)\r\n',"\tEnd Property\r\n"]},generateClass:function(e,r,n){var i=this,s=["Class ",e,"\r\n",this.constScript,"\r\n"];return t.each(r,function(t){n[t]?s.push("\tPublic ["+t+"]\r\n"):(s.push.apply(s,i.generateSetter(t)),s.push.apply(s,i.generateGetter(t)))}),s.push("End Class\r\n"),s.join("")},generateClassConstructor:function(t,e,r){var n=[t.length,"[",t.join(","),"]","[",r.join(","),"]"].join(""),i=this.classPool[n];if(i)return i;var s=this.generateClassName();return i=this.parseClassConstructorName(s),parseVB(this.generateClass(s,t,e)),parseVB(["Function ",i,"(desc)\r\n","\tDim o\r\n","\tSet o = (New ",s,")(desc)\r\n","\tSet ",i," = o\r\n","End Function"].join("")),this.classPool[n]=i,i},create:function(e,r){function n(r){t.isFunc(e[r])&&(u[r]=!0,a.push(r)),c.push(r)}var i=this,s=void 0,o=void 0,c=[],a=[],u={},h=this.descBind;return t.isArray(e)?(s=this.reserveArrayProps,o=this.reserveArrayPropMap):(s=this.reserveProps,o=this.reservePropMap),t.each(s,n),t.each(e,function(t,e){e===h||e in o||n(e)},e,!1),r||(r=this.descriptor(e),r?e=r.obj:r=new R(e,c,this)),proxy=window[this.generateClassConstructor(c,u,a)](r),r.proxy=proxy,t.each(a,function(t){proxy[t]=i.funcProxy(e[t],t in o?e:proxy)}),this.onProxyChange(e,proxy),r},funcProxy:function(t,e){return function(){return t.apply(this===window?e:this,arguments)}},eq:function(t,e){var r=this.descriptor(t),n=this.descriptor(e);return r&&(t=r.obj),n&&(e=n.obj),t===e},obj:function(t){var e=this.descriptor(t);return e?e.obj:t},proxy:function(t){var e=this.descriptor(t);return e?e.proxy:void 0},isProxy:function(t){return C.call(t,this.constBind)},descriptor:function(t){var e=this.descBind;return C.call(t,e)?t[e]:void 0},destroy:function(t){this.onProxyChange(obj,void 0)}}),R=t.dynamicClass({constructor:function(e,r,n){this.classGenerator=n,this.obj=e,this.defines=t.reverseConvert(r,function(){return!1}),e[n.descBind]=this,this.accessorNR=0},isAccessor:function(t){return t&&(t.get||t.set)},hasAccessor:function(){return!!this.accessorNR},defineProperty:function(e,r){var n=this.defines,i=this.obj;return e in n||(e in i?t.isFunc(i[e])&&d.warn("defineProperty not support function ["+e+"]"):i[e]=void 0,this.classGenerator.create(this.obj,this)),this.isAccessor(r)?(n[e]=r,this.accessorNR++,r.get&&(i[e]=r.get())):(n[e]&&(n[e]=!1,this.accessorNR--),i[e]=r.value),this.proxy},getPropertyDefine:function(t){return this.defines[t]||void 0},get:function(t){var e=this.defines[t];return e&&e.get?e.get.call(this.proxy):this.obj[t]},set:function(t,e){var r=this.defines[t];r&&r.set?r.set.call(this.proxy,e):this.obj[t]=e}}),B=void 0;S.isSupport=function(){if(void 0!==B)return B;if(B=!1,window.VBArray)try{window.execScript(["Function parseVB(code)","\tExecuteGlobal(code)","End Function"].join("\n"),"VBScript"),B=!0}catch(t){d.error(t.message,t)}return B};var A="fill,pop,push,reverse,shift,sort,splice,unshift".split(",");c.register({defaultProps:[]});var K={init:function(){this.isArray=t.isArray(this.obj),this.watchers={},this.isArray&&(this.hookArrayMethod=this.hookArrayMethod.bind(this),this.hookArray())},watch:function(t){var e=this.watchers;e[t]||this.isArray&&"length"==t||(this.defineProperty(t,this.obj[t]),e[t]=!0)},unwatch:function(t){var e=this.watchers;!e[t]||this.isArray&&"length"==t||(this.undefineProperty(t,this.obj[t]),e[t]=!1)},hookArray:function(){t.each(A,this.hookArrayMethod)},hookArrayMethod:function(t){var e=this.obj,r=Array.prototype[t],n=e.length,i=this;e[t]=function(){var t=r.apply(e,arguments);return i.addChangeRecord("length",n),n=e.length,t}}};w.registerPolicy("ES5DefineProperty",10,function(t){if(Object.defineProperty)try{var e=function(){var t=void 0,e={};return Object.defineProperty(e,"sentinel",{get:function(){return t},set:function(e){t=e}}),e.sentinel=1,{v:e.sentinel===t}}();if("object"==typeof e)return e.v}catch(t){}return!1},function(e){return t.assignIf({defineProperty:function(t,e){var r=this;Object.defineProperty(this.target,t,{enumerable:!0,configurable:!0,get:function(){return e},set:function(n){var i=e;e=n,r.addChangeRecord(t,i)}})},undefineProperty:function(t,e){Object.defineProperty(this.target,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}},K)}),w.registerPolicy("DefineGetterAndSetter",20,function(t){return"__defineGetter__"in{}},function(e){return t.assignIf({defineProperty:function(t,e){var r=this;this.target.__defineGetter__(t,function(){return e}),this.target.__defineSetter__(t,function(n){var i=e;e=n,r.addChangeRecord(t,i)})},undefineProperty:function(t,e){this.target.__defineGetter__(t,function(){return e}),this.target.__defineSetter__(t,function(t){e=t})}},K)}),w.registerPolicy("VBScriptProxy",30,function(t){return S.isSupport()},function(r){var n=void 0;return e.enable({obj:function(t){return t&&n.obj(t)},eq:function(t,r){return t===r||e.obj(t)===e.obj(r)},proxy:function(t){return t&&(n.proxy(t)||t)}}),n=w.vbfactory=new S([r.proxyListenKey,r.observerKey,r.expressionKey,t.LinkedList.ListKey].concat(r.defaultProps||[]),e.change),t.assignIf({defineProperty:function(t,e){var r=this,i=this.obj;this.target=(n.descriptor(i)||n.create(i)).defineProperty(t,{set:function(e){var n=i[t];i[t]=e,r.addChangeRecord(t,n)}})},undefineProperty:function(t,e){var r=this.obj,i=n.descriptor(r);i&&i.defineProperty(t,{value:e})}},K)});var L=t.assign({eq:function(t,r){return e.eq(t,r)},obj:function(t){return e.obj(t)},onproxy:function(t,r){return e.on(t,r)},unproxy:function(t,r){return e.un(t,r)},proxy:e,config:c.get(),$each:function(e,r,n,i){return o(t.each,e,r,n,i)},$map:function(e,r,n,i){return o(t.map,e,r,n,i)},$filter:function(e,r,n,i){return o(t.filter,e,r,n,i)},$aggregate:function(t,r,n,i,s){var o=n;return each(t,function(t,n,i,s){o=r.call(this,o,e.proxy(t),n,i,s)},i,s),o},$keys:function(t,r,n,i){var s=[];return each(t,function(t,n,i,o){r&&!r.call(this,e.proxy(t),n,i,o)||s.push(n)},n,i),s},$values:function(t,r,n,i){var s=[];return each(t,function(t,n,i,o){r&&!r.call(this,e.proxy(t),n,i,o)||s.push(t)},n,i),s}},w),N=t.assignIf(t.create(L),{observer:L,utility:t},t);return N});
//# sourceMappingURL=observer.min.js.map